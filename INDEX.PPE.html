<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORCP PPE ISSUE FORM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); border: none; }
        .card-header { background-color: #0d6efd; color: white; border-radius: 10px 10px 0 0 !important; padding: 15px 20px; }
        .form-container { padding: 20px; }
        .btn-primary { background-color: #0d6efd; border: none; }
        .btn-primary:hover { background-color: #0b5ed7; }
        .btn-success { background-color: #198754; }
        .material-suggestion { max-height: 200px; overflow-y: auto; position: absolute; width: 100%; z-index: 1000; display: none; }
        .suggestion-item { padding: 8px 15px; cursor: pointer; border-bottom: 1px solid #eee; background: white; }
        .suggestion-item:hover { background-color: #f0f0f0; }
        .logo-container { text-align: center; margin-bottom: 20px; }
        .logo { max-width: 180px; height: auto; }
        .required-field::after { content: "*"; color: red; margin-left: 4px; }
        .preview-table { font-size: 14px; }
        .preview-table th { background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container my-5">
        <div class="logo-container">
            <div class="logo">
                <i class="fas fa-hard-hat fa-4x text-primary"></i>
            </div>
            <h2 class="mt-3">ORCP PPE ISSUE FORM FOR PROJECTS</h2>
            <p class="text-muted">Record and track personal protective equipment distribution</p>
        </div>

        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>PPE Issue Form</h4>
            </div>
            <div class="form-container">
                <form id="ppeForm">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="employeeName" class="form-label required-field">Employee Name</label>
                                <input type="text" class="form-control" id="employeeName" required>
                            </div>
                            <div class="mb-3">
                                <label for="fileNo" class="form-label required-field">File Number</label>
                                <input type="text" class="form-control" id="fileNo" required>
                            </div>
                            <div class="mb-3" style="position: relative;">
                                <label for="material" class="form-label required-field">Material Name</label>
                                <input type="text" class="form-control" id="material" autocomplete="off" required>
                                <div id="materialSuggestions" class="material-suggestion card"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="project" class="form-label required-field">Project</label>
                                <select class="form-select" id="project" required>
                                    <option value="" selected disabled>Select Project</option>
                                    <option value="KSA-MARJAN-S013">KSA-MARJAN-S013</option>
                                    <option value="KSA-OYUN-S012">KSA-OYUN-S012</option>
                                    <option value="KSA-JAFURA-S015">KSA-JAFURA-S015</option>
                                    <option value="KSA-JAFURA-S019">KSA-JAFURA-S019</option>
                                    <option value="KSA-DAMMAM-S020">KSA-DAMMAM-S020</option>
                                    <option value="KSA-JAFURA-S021">KSA-JAFURA-S021</option>
                                    <option value="KSA-FADHALI-S022">KSA-FADHALI-S022</option>
                                    <option value="KSA-JAFURA-NMP">KSA-JAFURA-NMP</option>
                                    <option value="KSA-JUBAILYARD">KSA-JUBAIL-YARD</option>
                                    <option value="KSA-ABQAIQYARD">KSA-ABQAIQ-YARD</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="quantity" class="form-label required-field">Quantity</label>
                                <input type="number" class="form-control" id="quantity" min="1" required>
                            </div>
                            <div class="mb-3">
                                <label for="issueDate" class="form-label required-field">Issue Date</label>
                                <input type="date" class="form-control" id="issueDate" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="issuerName" class="form-label required-field">Issuer Name</label>
                                <input type="text" class="form-control" id="issuerName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="remarks" class="form-label">Remarks</label>
                                <textarea class="form-control" id="remarks" rows="2"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" id="downloadReport" class="btn btn-success">
                            <i class="fas fa-download me-2"></i>Download Excel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-2"></i>Update Record
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Confirm PPE Issue Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Please review the details before updating:</p>
                        <div class="table-responsive">
                            <table class="table table-bordered preview-table">
                                <tr><th width="150">Employee Name:</th><td id="previewEmployee"></td></tr>
                                <tr><th>File Number:</th><td id="previewFileNo"></td></tr>
                                <tr><th>Material:</th><td id="previewMaterial"></td></tr>
                                <tr><th>Project:</th><td id="previewProject"></td></tr>
                                <tr><th>Quantity:</th><td id="previewQuantity"></td></tr>
                                <tr><th>Issue Date:</th><td id="previewDate"></td></tr>
                                <tr><th>Issuer Name:</th><td id="previewIssuer"></td></tr>
                                <tr><th>Remarks:</th><td id="previewRemarks"></td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="confirmUpdate" class="btn btn-primary">Confirm & Update</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('issueDate').valueAsDate = new Date();
            const ppeForm = document.getElementById('ppeForm');
            const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));

            // Load previous submissions
            let submissions = JSON.parse(localStorage.getItem('ppeData')) || [];

            // Material suggestions array
            const materialList = [
                "4000001846 SAFETY PIN FOR CHICAGO COUPLING",
                "6200000118 SAFETY GOGGLES CLEAR",
                "6200000086 SAFETY SHOES FOR WORKERS-39",
                "6200000087 SAFETY SHOES FOR WORKERS-40",
                "6200000088 SAFETY SHOES FOR WORKERS-41",
                "6200000089 SAFETY SHOES FOR WORKERS-42",
                "6200000090 SAFETY SHOES FOR WORKERS-43",
                "6200000091 SAFETY SHOES FOR WORKERS-44",
                "6200000642 SAFETY SHOES FOR STAFF-39",
                "6200000080 SAFETY SHOES FOR STAFF-40",
                "6200000081 SAFETY SHOES FOR STAFF-41",
                "6200000082 SAFETY SHOES FOR STAFF-42",
                "6200000083 SAFETY SHOES FOR STAFF-43",
                "6200000084 SAFETY SHOES FOR STAFF-44",
                "6200000079 SAFETY HARNESS W/LANYARD & BIG HOOK",
                "4000000176 SAFETY GOOGLES-DARK",
                "6200000135 COVERALL DISPOSABLE TYPE",
                "6200000019 COVERALL DARK BLUE 100% COTTON SMALL",
                "6200000017 COVERALL DARK BLUE 100% COTTON LARGE",
                "6200000014 COVERALL DARK BLUE 100% COTTON 2XLARGE",
                "6200000227 COVERALL 2XLARGE DARK BLUE",
                "6200000225 COVERALL LARGE DARK BLUE",
                "6200000224 COVERALL MEDIUM DARK BLUE",
                "6200000333 COVERALL SMALL DARK BLUE",
                "6200000226 COVERALL XLARGE DARK BLUE",
                "6200000742 COVERALL 3XLARGE DARK BLUE",
                "6200000782 GLOVES-RUBBER TYPE,CHEMICAL RESISTANCE",
                "6200000060 GLOVES-WORKING TYPE",
                "6200000070 HELMET YELLOW MSA",
                "6200000069 HELMET WHITE MSA GEAR TYPE",
                "4000000189 VISOR FOR SAND BLASTING HELMET-INNER",
                "4000006961 VISOR FOR SAND BLASTING HELMET-OUTER"
            ];

            const materialInput = document.getElementById('material');
            const materialSuggestions = document.getElementById('materialSuggestions');

            materialInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                materialSuggestions.innerHTML = '';
                if(query) {
                    const matches = materialList.filter(item => item.toLowerCase().includes(query));
                    matches.forEach(item => {
                        const div = document.createElement('div');
                        div.classList.add('suggestion-item');
                        div.textContent = item;
                        div.addEventListener('click', () => {
                            materialInput.value = item;
                            materialSuggestions.style.display = 'none';
                        });
                        materialSuggestions.appendChild(div);
                    });
                    materialSuggestions.style.display = matches.length ? 'block' : 'none';
                } else {
                    materialSuggestions.style.display = 'none';
                }
            });

            document.addEventListener('click', function(e) {
                if(!materialInput.contains(e.target) && !materialSuggestions.contains(e.target)) {
                    materialSuggestions.style.display = 'none';
                }
            });

            // Show confirmation modal on submit
            ppeForm.addEventListener('submit', function(e) {
                e.preventDefault();
                document.getElementById('previewEmployee').textContent = document.getElementById('employeeName').value;
                document.getElementById('previewFileNo').textContent = document.getElementById('fileNo').value;
                document.getElementById('previewMaterial').textContent = document.getElementById('material').value;
                document.getElementById('previewProject').textContent = document.getElementById('project').value;
                document.getElementById('previewQuantity').textContent = document.getElementById('quantity').value;
                document.getElementById('previewDate').textContent = document.getElementById('issueDate').value;
                document.getElementById('previewIssuer').textContent = document.getElementById('issuerName').value;
                document.getElementById('previewRemarks').textContent = document.getElementById('remarks').value || 'N/A';
                confirmationModal.show();
            });

            // Confirm update â†’ save locally
            document.getElementById('confirmUpdate').addEventListener('click', function() {
                const formData = {
                    employee: document.getElementById('employeeName').value,
                    fileNo: document.getElementById('fileNo').value,
                    material: document.getElementById('material').value,
                    project: document.getElementById('project').value,
                    quantity: document.getElementById('quantity').value,
                    issueDate: document.getElementById('issueDate').value,
                    issuer: document.getElementById('issuerName').value,
                    remarks: document.getElementById('remarks').value || 'N/A'
                };

                submissions.push(formData);
                localStorage.setItem('ppeData', JSON.stringify(submissions));

                alert("PPE record saved successfully!");

                confirmationModal.hide();
                ppeForm.reset();
                document.getElementById('issueDate').valueAsDate = new Date();
            });

            // Download Excel with headers and auto-fit
            document.getElementById('downloadReport').addEventListener('click', function() {
                if(submissions.length === 0) {
                    alert("No data available to download!");
                    return;
                }

                const headers = ["Employee Name","File Number","Material","Project","Quantity","Issue Date","Issuer Name","Remarks"];
                const data = [headers];

                submissions.forEach(sub => {
                    data.push([
                        sub.employee,
                        sub.fileNo,
                        sub.material,
                        sub.project,
                        sub.quantity,
                        sub.issueDate,
                        sub.issuer,
                        sub.remarks
                    ]);
                });

                const ws = XLSX.utils.aoa_to_sheet(data);

                // Auto-fit columns
                const colWidths = headers.map((h, i) => {
                    const maxLength = data.reduce((max, row) => {
                        const cell = row[i] ? row[i].toString() : '';
                        return Math.max(max, cell.length);
                    }, h.length);
                    return { wch: maxLength + 2 };
                });
                ws['!cols'] = colWidths;

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "PPE Submissions");
                XLSX.writeFile(wb, "ppe_submissions.xlsx");
            });
        });
    </script>
</body>
</html>
