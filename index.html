<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Scaffolding Material Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #34495e;
      --accent: #3498db;
      --light: #ecf0f1;
      --success: #2ecc71;
      --warning: #f39c12;
      --danger: #e74c3c;
      --dark-text: #2c3e50;
      --light-text: #7f8c8d;
      --card-shadow: 0 10px 20px rgba(0,0,0,0.12);
      --hover-shadow: 0 14px 28px rgba(0,0,0,0.25);
    }
    
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--dark-text);
    }
    
    .dashboard-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 25px 0;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }
    
    .dashboard-header::before {
      content: "";
      position: absolute;
      top: -10px;
      left: -10px;
      right: -10px;
      bottom: -10px;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      z-index: -1;
    }
    
    .card {
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      margin-bottom: 24px;
      border: none;
      overflow: hidden;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: var(--hover-shadow);
    }
    
    .card-header {
      background: linear-gradient(to right, var(--secondary), var(--primary));
      color: white;
      border-radius: 12px 12px 0 0 !important;
      font-weight: 600;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .card-header i {
      margin-right: 8px;
    }
    
    .summary-card { 
      text-align: center; 
      padding: 20px 15px;
      position: relative;
    }
    
    .summary-card::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      height: 4px;
      width: 40%;
      background: linear-gradient(to right, var(--accent), var(--primary));
      border-radius: 2px;
    }
    
    .summary-number { 
      font-size: 2.5rem; 
      font-weight: 800; 
      color: var(--primary); 
      margin: 10px 0;
    }
    
    .summary-title { 
      font-size: 0.95rem; 
      color: var(--light-text); 
      font-weight: 600; 
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stats-icon { 
      font-size: 2.8rem; 
      color: var(--accent); 
      margin-bottom: 15px;
      background: linear-gradient(135deg, var(--accent), var(--primary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .material-table { 
      width: 100%; 
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .material-table th { 
      background-color: var(--primary); 
      color: white; 
      position: sticky;
      top: 0;
      padding: 12px 15px;
    }
    
    .material-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eaeaea;
    }
    
    .material-table tr:nth-child(even) { 
      background-color: #f8f9fa; 
    }
    
    .material-table tr:last-child td {
      border-bottom: none;
    }
    
    .site-header { 
      background-color: var(--accent) !important; 
      color: white; 
      text-align: center; 
    }
    
    .low-stock { background-color: rgba(231, 76, 60, 0.1) !important; }
    .medium-stock { background-color: rgba(243, 156, 18, 0.1) !important; }
    .high-stock { background-color: rgba(46, 204, 113, 0.1) !important; }
    
    .filter-section {
      background-color: white; 
      border-radius: 12px; 
      padding: 20px; 
      margin-bottom: 25px;
      box-shadow: var(--card-shadow);
    }
    
    .dashboard-section { 
      margin-bottom: 35px; 
    }
    
    .site-balance { 
      font-weight: 700; 
      text-align: center;
    }
    
    .site-balance.low { color: var(--danger); }
    .site-balance.medium { color: var(--warning); }
    .site-balance.high { color: var(--success); }
    
    .table-responsive { 
      max-height: 450px; 
      overflow-y: auto;
      border-radius: 0 0 10px 10px;
    }
    
    .btn-advanced {
      background: linear-gradient(to right, var(--accent), var(--primary));
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-advanced:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      color: white;
    }
    
    .input-advanced {
      border-radius: 8px;
      padding: 12px 15px;
      border: 1px solid #e0e0e0;
      transition: all 0.3s;
    }
    
    .input-advanced:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
    }
    
    .custom-file-upload {
      display: inline-block;
      padding: 12px 20px;
      cursor: pointer;
      background: linear-gradient(to right, var(--accent), var(--primary));
      color: white;
      border-radius: 8px;
      transition: all 0.3s;
      text-align: center;
      font-weight: 600;
    }
    
    .custom-file-upload:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .custom-file-upload i {
      margin-right: 8px;
    }
    
    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: var(--danger);
      color: white;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    .progress-bar-container {
      height: 8px;
      background-color: #e0e0e0;
      border-radius: 4px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .dashboard-tabs {
      margin-bottom: 25px;
    }
    
    .dashboard-tabs .nav-link {
      color: var(--dark-text);
      font-weight: 600;
      border-radius: 8px;
      margin-right: 10px;
      padding: 10px 20px;
      transition: all 0.3s;
    }
    
    .dashboard-tabs .nav-link.active {
      background: linear-gradient(to right, var(--accent), var(--primary));
      color: white;
    }
    
    .dashboard-tabs .nav-link:hover:not(.active) {
      background-color: #eaeaea;
    }
    
    .trend-indicator {
      font-size: 0.9rem;
      margin-left: 5px;
    }
    
    .trend-up {
      color: var(--success);
    }
    
    .trend-down {
      color: var(--danger);
    }
    
    .trend-neutral {
      color: var(--warning);
    }
    
    .material-image {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
      margin-right: 10px;
      background-color: #eaeaea;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: var(--accent);
    }
    
    @media (max-width: 768px) {
      .summary-number {
        font-size: 2rem;
      }
      
      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .card-header .btn {
        margin-top: 10px;
        align-self: flex-end;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p>Processing your data...</p>
  </div>

  <header class="dashboard-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h1><i class="fas fa-hard-hat me-3"></i>Advanced Scaffolding Dashboard</h1>
          <p class="lead">Comprehensive material tracking with advanced analytics</p>
        </div>
        <div class="col-md-6 text-md-end">
          <div class="btn-group">
            <label class="custom-file-upload">
              <i class="fas fa-file-import me-2"></i>Import CSV
              <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
            </label>
            <button class="btn btn-advanced ms-2" id="exportBtn">
              <i class="fas fa-file-export me-2"></i>Export Data
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Dashboard Tabs -->
    <ul class="nav nav-pills dashboard-tabs" id="dashboardTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" type="button" role="tab">Overview</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="materials-tab" data-bs-toggle="pill" data-bs-target="#materials" type="button" role="tab">Materials</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="sites-tab" data-bs-toggle="pill" data-bs-target="#sites" type="button" role="tab">Sites</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="analytics-tab" data-bs-toggle="pill" data-bs-target="#analytics" type="button" role="tab">Analytics</button>
      </li>
    </ul>

    <div class="tab-content" id="dashboardTabContent">
      <!-- Overview Tab -->
      <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <!-- Summary Cards -->
        <div class="row dashboard-section">
          <div class="col-md-3">
            <div class="card summary-card">
              <div><i class="fas fa-boxes stats-icon"></i></div>
              <div class="summary-number" id="totalMaterials">0</div>
              <div class="summary-title">TOTAL MATERIAL TYPES</div>
              <div class="progress-bar-container">
                <div class="progress-bar" style="width: 0%; background-color: var(--accent);"></div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card summary-card">
              <div><i class="fas fa-warehouse stats-icon"></i></div>
              <div class="summary-number" id="totalSites">0</div>
              <div class="summary-title">SITES</div>
              <div class="progress-bar-container">
                <div class="progress-bar" style="width: 0%; background-color: var(--primary);"></div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card summary-card">
              <div><i class="fas fa-chart-line stats-icon"></i></div>
              <div class="summary-number" id="avgStock">0</div>
              <div class="summary-title">AVERAGE STOCK LEVEL</div>
              <div class="progress-bar-container">
                <div class="progress-bar" style="width: 0%; background-color: var(--success);"></div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card summary-card">
              <div><i class="fas fa-exclamation-triangle stats-icon"></i></div>
              <div class="summary-number" id="lowStockItems">0</div>
              <div class="summary-title">LOW STOCK ITEMS</div>
              <div class="progress-bar-container">
                <div class="progress-bar" style="width: 0%; background-color: var(--danger);"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="filter-section">
          <div class="row">
            <div class="col-md-5 mb-3 mb-md-0">
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" id="searchInput" class="form-control input-advanced" placeholder="Search material code or name...">
              </div>
            </div>
            <div class="col-md-3 mb-3 mb-md-0">
              <select id="siteFilter" class="form-select input-advanced">
                <option value="">All Sites</option>
              </select>
            </div>
            <div class="col-md-2 mb-3 mb-md-0">
              <select id="stockFilter" class="form-select input-advanced">
                <option value="">All Stock Levels</option>
                <option value="low">Low Stock</option>
                <option value="medium">Medium Stock</option>
                <option value="high">High Stock</option>
              </select>
            </div>
            <div class="col-md-2">
              <select id="sortFilter" class="form-select input-advanced">
                <option value="name">Sort by Name</option>
                <option value="code">Sort by Code</option>
                <option value="total-high">Total (High to Low)</option>
                <option value="total-low">Total (Low to High)</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="row dashboard-section">
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <span><i class="fas fa-chart-pie me-2"></i>Stock Distribution by Site</span>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="chartToggle" checked>
                  <label class="form-check-label text-light" for="chartToggle">Show Values</label>
                </div>
              </div>
              <div class="card-body"><canvas id="siteChart" height="250"></canvas></div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <span><i class="fas fa-chart-bar me-2"></i>Top Materials by Total Balance</span>
                <div class="btn-group btn-group-sm">
                  <button type="button" class="btn btn-light active" data-chart-type="bar">Bar</button>
                  <button type="button" class="btn btn-light" data-chart-type="horizontalBar">Horizontal</button>
                </div>
              </div>
              <div class="card-body"><canvas id="materialChart" height="250"></canvas></div>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="dashboard-section">
          <div class="card">
            <div class="card-header">
              <span><i class="fas fa-table me-2"></i>Material Details</span>
              <div>
                <button class="btn btn-sm btn-light" id="toggleViewBtn">
                  <i class="fas fa-columns me-1"></i> Toggle View
                </button>
                <button class="btn btn-sm btn-light ms-2" id="expandAllBtn">
                  <i class="fas fa-expand me-1"></i> Expand All
                </button>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover material-table" id="materialTable">
                  <thead>
                    <tr>
                      <th>Material</th>
                      <th>Code</th>
                      <th>Total Balance</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="materialData"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Other tabs would go here -->
      <div class="tab-pane fade" id="materials" role="tabpanel">
        <div class="card">
          <div class="card-header">Materials Management</div>
          <div class="card-body">
            <p class="text-center text-muted">Upload a CSV file to see detailed material information</p>
          </div>
        </div>
      </div>
      
      <div class="tab-pane fade" id="sites" role="tabpanel">
        <div class="card">
          <div class="card-header">Sites Overview</div>
          <div class="card-body">
            <p class="text-center text-muted">Upload a CSV file to see site distribution and analytics</p>
          </div>
        </div>
      </div>
      
      <div class="tab-pane fade" id="analytics" role="tabpanel">
        <div class="card">
          <div class="card-header">Advanced Analytics</div>
          <div class="card-body">
            <p class="text-center text-muted">Upload a CSV file to unlock advanced analytics features</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // DOM Elements
      const csvFileInput = document.getElementById("csvFileInput");
      const exportBtn = document.getElementById("exportBtn");
      const searchInput = document.getElementById("searchInput");
      const siteFilter = document.getElementById("siteFilter");
      const stockFilter = document.getElementById("stockFilter");
      const sortFilter = document.getElementById("sortFilter");
      const toggleViewBtn = document.getElementById("toggleViewBtn");
      const expandAllBtn = document.getElementById("expandAllBtn");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const chartToggle = document.getElementById("chartToggle");
      
      // Data variables
      let materialData = [];
      let sites = [];
      let isDetailedView = true;
      let siteChart, materialChart;
      let currentMaterialChartType = 'bar';

      // Event Listeners
      csvFileInput.addEventListener("change", handleFileUpload);
      exportBtn.addEventListener("click", exportData);
      searchInput.addEventListener("input", filterMaterials);
      siteFilter.addEventListener("change", filterMaterials);
      stockFilter.addEventListener("change", filterMaterials);
      sortFilter.addEventListener("change", filterMaterials);
      toggleViewBtn.addEventListener("click", toggleView);
      expandAllBtn.addEventListener("click", expandAllRows);
      chartToggle.addEventListener("change", toggleChartDataLabels);
      
      // Add event listeners for chart type buttons
      document.querySelectorAll('[data-chart-type]').forEach(button => {
        button.addEventListener('click', function() {
          document.querySelectorAll('[data-chart-type]').forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          currentMaterialChartType = this.getAttribute('data-chart-type');
          if (materialData.length > 0) renderCharts();
        });
      });

      function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        showLoading();
        
        // Simulate processing delay for better UX
        setTimeout(() => {
          const reader = new FileReader();
          reader.onload = e => { 
            parseCSVData(e.target.result); 
            hideLoading();
          };
          reader.readAsText(file);
        }, 1500);
      }

      function showLoading() {
        loadingOverlay.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }

      function hideLoading() {
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
          loadingOverlay.style.display = 'none';
          document.body.style.overflow = 'auto';
        }, 500);
      }

      function parseCSVData(csvData) {
        try {
          const rows = csvData.split(/\r?\n/).map(r => r.split(","));
          if (rows.length < 2) { 
            alert("CSV file is empty or invalid");
            return; 
          }
          
          const headers = rows[0];
          sites = headers.slice(7).map(h => h.trim()).filter(h => h);
          
          // Update site filter
          siteFilter.innerHTML = '<option value="">All Sites</option>';
          sites.forEach(site => {
            const option = document.createElement("option");
            option.value = site; 
            option.textContent = site;
            siteFilter.appendChild(option);
          });
          
          // Process material data
          materialData = [];
          for (let i = 1; i < rows.length; i++) {
            const row = rows[i]; 
            if (row.length < 8) continue;
            
            const code = row[1]?.trim(); 
            const name = row[2]?.trim();
            const total = parseInt(row[6]) || 0;
            const siteBalances = row.slice(7, 7 + sites.length).map(v => parseInt(v) || 0);
            
            if (code && name) {
              materialData.push({ 
                code, 
                name, 
                total, 
                siteBalances,
                status: total < 100 ? 'low' : total < 500 ? 'medium' : 'high'
              });
            }
          }
          
          updateDashboard();
          
          // Enable all tabs after data is loaded
          document.querySelectorAll('.nav-link:not(#overview-tab)').forEach(tab => {
            tab.classList.remove('disabled');
          });
          
        } catch (error) {
          alert("Error parsing CSV file: " + error.message);
          hideLoading();
        }
      }

      function updateDashboard() { 
        updateSummary(); 
        renderCharts(); 
        renderTable(); 
      }

      function updateSummary() {
        // Update summary numbers
        document.getElementById("totalMaterials").textContent = materialData.length.toLocaleString();
        document.getElementById("totalSites").textContent = sites.length;
        
        const totalStock = materialData.reduce((s, m) => s + m.total, 0);
        const avgStock = Math.round(totalStock / materialData.length || 0);
        document.getElementById("avgStock").textContent = avgStock.toLocaleString();
        
        const lowStockCount = materialData.filter(m => m.total < 100).length;
        document.getElementById("lowStockItems").textContent = lowStockCount.toLocaleString();
        
        // Update progress bars
        document.querySelectorAll('.progress-bar').forEach((bar, index) => {
          switch(index) {
            case 0: 
              bar.style.width = Math.min(materialData.length / 100 * 100, 100) + '%'; 
              break;
            case 1: 
              bar.style.width = Math.min(sites.length / 10 * 100, 100) + '%'; 
              break;
            case 2: 
              bar.style.width = Math.min(avgStock / 1000 * 100, 100) + '%'; 
              break;
            case 3: 
              bar.style.width = Math.min(lowStockCount / materialData.length * 100, 100) + '%'; 
              break;
          }
        });
      }

      function renderCharts() {
        // Destroy existing charts if they exist
        if (siteChart) siteChart.destroy();
        if (materialChart) materialChart.destroy();
        
        // Site Distribution Chart
        const siteCtx = document.getElementById("siteChart").getContext("2d");
        const siteTotals = sites.map((s, i) => materialData.reduce((sum, m) => sum + m.siteBalances[i], 0));
        
        siteChart = new Chart(siteCtx, {
          type: "pie",
          data: {
            labels: sites,
            datasets: [{
              data: siteTotals,
              backgroundColor: [
                "#3498db", "#2ecc71", "#e74c3c", "#f39c12", 
                "#9b59b6", "#1abc9c", "#d35400", "#34495e",
                "#16a085", "#27ae60", "#2980b9", "#8e44ad"
              ],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
                labels: {
                  font: {
                    size: 12
                  }
                }
              },
              title: {
                display: true,
                text: "Total Stock by Site",
                font: {
                  size: 16
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.label}: ${context.raw.toLocaleString()}`;
                  }
                }
              },
              datalabels: {
                display: chartToggle.checked,
                color: '#fff',
                font: {
                  weight: 'bold',
                  size: 11
                },
                formatter: (value) => {
                  return value > 0 ? value.toLocaleString() : '';
                }
              }
            }
          }
        });
        
        // Material Chart
        const materialCtx = document.getElementById("materialChart").getContext("2d");
        const sorted = [...materialData].sort((a, b) => b.total - a.total).slice(0, 6);
        
        materialChart = new Chart(materialCtx, {
          type: currentMaterialChartType,
          data: {
            labels: sorted.map(m => m.name.length > 15 ? m.name.substring(0, 15) + '...' : m.name),
            datasets: [{
              label: 'Total Balance',
              data: sorted.map(m => m.total),
              backgroundColor: sorted.map(m => 
                m.status === 'low' ? 'rgba(231, 76, 60, 0.7)' : 
                m.status === 'medium' ? 'rgba(243, 156, 18, 0.7)' : 
                'rgba(46, 204, 113, 0.7)'
              ),
              borderColor: sorted.map(m => 
                m.status === 'low' ? 'rgba(231, 76, 60, 1)' : 
                m.status === 'medium' ? 'rgba(243, 156, 18, 1)' : 
                'rgba(46, 204, 113, 1)'
              ),
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              title: {
                display: true,
                text: "Top Materials by Total Balance",
                font: {
                  size: 16
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return value.toLocaleString();
                  }
                }
              },
              x: {
                ticks: {
                  maxRotation: currentMaterialChartType === 'bar' ? 45 : 0
                }
              }
            }
          }
        });
      }

      function renderTable(data = materialData) {
        const body = document.getElementById("materialData");
        body.innerHTML = "";
        
        // Apply sorting
        const sortValue = sortFilter.value;
        let sortedData = [...data];
        
        switch(sortValue) {
          case 'name':
            sortedData.sort((a, b) => a.name.localeCompare(b.name));
            break;
          case 'code':
            sortedData.sort((a, b) => a.code.localeCompare(b.code));
            break;
          case 'total-high':
            sortedData.sort((a, b) => b.total - a.total);
            break;
          case 'total-low':
            sortedData.sort((a, b) => a.total - b.total);
            break;
        }
        
        sortedData.forEach(m => {
          const row = document.createElement("tr");
          row.classList.add(m.status + "-stock");
          
          // Determine status badge
          let statusBadge = "";
          if (m.status === 'low') {
            statusBadge = '<span class="badge bg-danger">Low Stock</span>';
          } else if (m.status === 'medium') {
            statusBadge = '<span class="badge bg-warning text-dark">Medium Stock</span>';
          } else {
            statusBadge = '<span class="badge bg-success">High Stock</span>';
          }
          
          row.innerHTML = `
            <td>
              <div class="d-flex align-items-center">
                <div class="material-image">
                  <i class="fas fa-box"></i>
                </div>
                <div>
                  <div class="fw-bold">${m.name}</div>
                  <small class="text-muted">${m.code}</small>
                </div>
              </div>
            </td>
            <td>${m.code}</td>
            <td class="fw-bold">${m.total.toLocaleString()}</td>
            <td>${statusBadge}</td>
          `;
          
          // Add site columns if in detailed view
          if (isDetailedView) {
            m.siteBalances.forEach((b, i) => {
              const siteClass = b < 20 ? "low" : b < 50 ? "medium" : "high";
              const td = document.createElement("td"); 
              td.textContent = b.toLocaleString();
              td.classList.add("site-balance", siteClass); 
              row.appendChild(td);
            });
          }
          
          body.appendChild(row);
        });
        
        // Update table header based on view mode
        const head = document.querySelector("#materialTable thead tr");
        while (head.children.length > 4) head.removeChild(head.lastChild);
        
        if (isDetailedView) {
          sites.forEach(s => { 
            const th = document.createElement("th"); 
            th.textContent = s; 
            th.className = "site-header"; 
            head.appendChild(th); 
          });
        }
      }

      function filterMaterials() {
        const search = searchInput.value.toLowerCase();
        const site = siteFilter.value;
        const stock = stockFilter.value;
        
        const filteredData = materialData.filter(m => {
          // Search filter
          const matchSearch = m.code.toLowerCase().includes(search) || m.name.toLowerCase().includes(search);
          if (!matchSearch) return false;
          
          // Site filter
          let matchSite = !site;
          if (site) {
            const siteIndex = sites.indexOf(site);
            matchSite = m.siteBalances[siteIndex] > 0;
          }
          if (!matchSite) return false;
          
          // Stock level filter
          let matchStock = !stock;
          if (stock) {
            if (stock === "low") matchStock = m.total < 100;
            else if (stock === "medium") matchStock = m.total >= 100 && m.total < 500;
            else if (stock === "high") matchStock = m.total >= 500;
          }
          
          return matchStock;
        });
        
        renderTable(filteredData);
      }

      function toggleView() {
        isDetailedView = !isDetailedView;
        toggleViewBtn.innerHTML = isDetailedView ? 
          '<i class="fas fa-columns me-1"></i> Simplified View' : 
          '<i class="fas fa-columns me-1"></i> Detailed View';
        
        renderTable();
      }

      function expandAllRows() {
        // This would show more details about each material
        alert("Expanding all rows to show detailed information");
      }

      function toggleChartDataLabels() {
        // This would toggle data labels on the charts
        if (siteChart) {
          siteChart.options.plugins.datalabels.display = chartToggle.checked;
          siteChart.update();
        }
      }

      function exportData() {
        if (materialData.length === 0) {
          alert("No data to export. Please import a CSV file first.");
          return;
        }
        
        let csv = "Material Code,Material Name,Total Balance," + sites.join(",") + "\n";
        materialData.forEach(m => {
          csv += `${m.code},${m.name},${m.total},${m.siteBalances.join(",")}\n`;
        });
        
        const blob = new Blob([csv], { type: "text/csv" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "Scaffolding_Material_Data.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
      
      // Initialize with disabled tabs (until data is loaded)
      document.querySelectorAll('.nav-link:not(#overview-tab)').forEach(tab => {
        tab.classList.add('disabled');
      });
    });
  </script>
</body>
</html>
